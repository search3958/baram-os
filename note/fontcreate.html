<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>8x16 2bit Font Studio</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #e9ecef; padding: 20px; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .layout { display: flex; gap: 30px; }
        .sidebar { flex: 1; min-width: 300px; }
        .main-content { flex: 2; }
        
        .section { margin-bottom: 25px; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; }
        h2 { font-size: 1.1rem; margin-top: 0; color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        
        label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], input[type="file"], select { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        
        .preview-box { display: flex; flex-direction: column; align-items: center; background: #343a40; color: white; padding: 20px; border-radius: 8px; }
        canvas { 
            border: 1px solid #666; 
            background: #000; 
            image-rendering: pixelated; /* ドットをくっきり表示 */
            width: 128px;  /* 表示サイズを拡大 */
            height: 256px; 
        }
        
        textarea { width: 100%; height: 350px; font-family: 'Consolas', monospace; font-size: 11px; background: #212529; color: #f8f9fa; padding: 10px; border-radius: 4px; }
        button { width: 100%; background: #007bff; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #0056b3; }
        button.secondary { background: #28a745; margin-top: 10px; }
        button.secondary:hover { background: #218838; }
    </style>
</head>
<body>

<div class="container">
    <h1>8x16 2bit Font Studio</h1>
    
    <div class="layout">
        <div class="sidebar">
            <div class="section">
                <h2>1. フォント設定</h2>
                <label>使用フォント</label>
                <select id="fontFamily">
                    <option value="monospace">Monospace</option>
                    <option value="Arial">Arial</option>
                    <option value="serif">Serif</option>
                    <option value="custom">--- カスタム読込 ---</option>
                </select>
                <input type="file" id="fontFile" accept=".ttf,.otf,.woff" style="display:none;">
            </div>

            <div class="section">
                <h2>2. リアルタイムプレビュー</h2>
                <label>確認する文字 (1文字)</label>
                <input type="text" id="singleChar" maxlength="1" value="A" placeholder="A">
                <div class="preview-box">
                    <canvas id="prevCanvas" width="8" height="16"></canvas>
                    <p style="font-size: 0.7rem; margin-top: 10px;">拡大表示 (8x16px)</p>
                </div>
            </div>
            
            <button id="generateAllBtn" class="secondary">ASCII 256文字 全出力</button>
        </div>

        <div class="main-content">
            <div class="section">
                <h2>3. C言語形式バイナリ出力 (2bit)</h2>
                <textarea id="outputArea" readonly placeholder="「全出力」ボタンを押すとここにASCII 0-255のデータが生成されます..."></textarea>
            </div>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('prevCanvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });
const fontSelect = document.getElementById('fontFamily');
const fontFile = document.getElementById('fontFile');
const singleCharInput = document.getElementById('singleChar');
const outputArea = document.getElementById('outputArea');
const generateBtn = document.getElementById('generateAllBtn');

let customFontName = "";

// フォント切り替え
fontSelect.addEventListener('change', () => {
    fontFile.style.display = fontSelect.value === 'custom' ? 'block' : 'none';
    updatePreview();
});

// ファイル読み込み
fontFile.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        const fontFace = new FontFace('CustomFont', await file.arrayBuffer());
        await fontFace.load();
        document.fonts.add(fontFace);
        customFontName = 'CustomFont';
        updatePreview();
    }
});

// 入力時にプレビュー更新
singleCharInput.addEventListener('input', updatePreview);

function drawChar(char) {
    const font = fontSelect.value === 'custom' ? customFontName : fontSelect.value;
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, 8, 16);
    ctx.fillStyle = "white";
    ctx.font = `14px ${font}`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(char, 4, 8.5); // 8x16に合わせて微調整
}

function get2bitHex() {
    const imgData = ctx.getImageData(0, 0, 8, 16).data;
    let bytes = [];
    for (let y = 0; y < 16; y++) {
        let b1 = 0, b2 = 0;
        for (let x = 0; x < 8; x++) {
            const i = (y * 8 + x) * 4;
            const val = Math.floor(imgData[i] / 64); // 0-3 (2bit)
            if (x < 4) b1 |= (val << (6 - (x * 2)));
            else b2 |= (val << (6 - ((x - 4) * 2)));
        }
        bytes.push("0x" + b1.toString(16).toUpperCase().padStart(2, '0'));
        bytes.push("0x" + b2.toString(16).toUpperCase().padStart(2, '0'));
    }
    return bytes;
}

function updatePreview() {
    const char = singleCharInput.value || " ";
    drawChar(char);
}

generateBtn.addEventListener('click', () => {
    let result = `/* ASCII 8x16 2bit Font Table (0-255) */\n`;
    result += `/* Each character = 32 bytes (2 bytes per row) */\n\n`;
    result += `const unsigned char font_table[256][32] = {\n`;

    for (let i = 0; i < 256; i++) {
        const char = (i < 32 || (i >= 127 && i <= 160)) ? " " : String.fromCharCode(i);
        drawChar(char);
        const hexArray = get2bitHex();
        result += `    { ${hexArray.join(', ')} }, // 0x${i.toString(16).padStart(2, '0')} '${char}'\n`;
    }

    result += `};`;
    outputArea.value = result;
    // プレビューを入力していた文字に戻す
    updatePreview();
});

// 初期描画
window.onload = updatePreview;
</script>

</body>
</html>